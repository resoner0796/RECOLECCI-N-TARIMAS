<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Recolecci√≥n - Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <style>
        /* Estilos Generales y de Fondo */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #FFFFFF;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
            background-attachment: fixed;
        }

        /* Estilo Glassmorphism para la Tarjeta Principal */
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 25px;
            margin: 20px auto;
            max-width: 500px;
            width: 90%;
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            text-align: center;
        }

        /* T√≠tulos y texto */
        h2, h3, h4 {
            margin: 10px 0;
            font-weight: 500;
        }
        h2 { font-size: 1.8em; }
        h3 { font-size: 1.4em; }
        small { color: #cccccc; }

        /* Estilos de Inputs y Selects con efecto Glass */
        input, select {
            padding: 15px;
            width: calc(100% - 30px);
            margin: 12px 0;
            font-size: 16px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.15);
            color: #FFFFFF;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        input:focus, select:focus {
            outline: none;
            border: 1px solid rgba(0, 122, 255, 0.8);
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.5);
        }
        input::placeholder { color: #a0a0a0; }

        /* Estilos de Botones con efecto Glass */
        button {
            padding: 15px 20px;
            margin: 10px 0;
            cursor: pointer;
            font-size: 16px;
            border-radius: 12px;
            border: 1px solid transparent;
            width: 100%;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #FFFFFF;
        }
        button.btn-primary {
            background-color: rgba(0, 122, 255, 0.6);
            border-color: rgba(0, 122, 255, 0.8);
        }
        button.btn-green {
            background-color: rgba(76, 175, 80, 0.6);
            border-color: rgba(76, 175, 80, 0.8);
        }
        button.btn-orange {
            background-color: rgba(255, 193, 7, 0.6);
            border-color: rgba(255, 193, 7, 0.8);
            color: #000;
        }
        button.btn-danger {
            background-color: rgba(255, 59, 48, 0.6);
            border-color: rgba(255, 59, 48, 0.8);
        }
        button.btn-secondary {
            background-color: rgba(108, 117, 125, 0.5);
            border-color: rgba(108, 117, 125, 0.7);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        button:active {
            transform: translateY(0);
            filter: brightness(0.9);
        }

        /* Estilos de Listas */
        ul { padding-left: 0; list-style: none; }
        li {
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: left;
            overflow: hidden;
            word-wrap: break-word;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .list-item-btn {
            width: auto;
            padding: 5px 10px;
            margin-left: 5px;
            flex-shrink: 0;
        }
        .edit-delete-btns {
            display: inline-flex;
            gap: 5px;
        }
        .edit-delete-btns button {
            width: auto;
            padding: 8px 12px;
            margin: 0;
        }

        /* Mensajes de Estado */
        #statusMessage {
            padding: 12px;
            margin: 15px 0;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        .status-success { background: rgba(52, 199, 89, 0.7); border: 1px solid rgba(52, 199, 89, 1); }
        .status-info { background: rgba(90, 200, 250, 0.7); border: 1px solid rgba(90, 200, 250, 1); }
        .status-error { background: rgba(255, 59, 48, 0.7); border: 1px solid rgba(255, 59, 48, 1); }

        /* Estilos del Modal del Esc√°ner con efecto Glass */
        #scannerModal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            justify-content: center; align-items: center;
            z-index: 100;
            flex-direction: column;
        }
        #scannerModal.active { display: flex; }
        .scanner-frame-container {
            position: relative;
            width: 90%;
            max-width: 400px;
            aspect-ratio: 1 / 1;
            border: 2px solid rgba(0, 122, 255, 0.8);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 122, 255, 0.5);
        }
        #preview { width: 100%; height: 100%; object-fit: cover; }
        .scanner-frame::before {
            content: '';
            position: absolute; top: 0; left: 0;
            width: 100%; height: 3px;
            background-color: #ff3b30;
            animation: scan-line 2.5s infinite ease-in-out;
            box-shadow: 0 0 10px #ff3b30;
        }
        @keyframes scan-line {
            0%, 100% { top: 0; }
            50% { top: calc(100% - 3px); }
        }

        /* Estilos para Escritorio */
        @media (min-width: 768px) {
            .card { max-width: 1000px; padding: 40px; }
            .dashboard-container, .report-container {
                display: grid;
                grid-template-columns: 1fr 2fr;
                gap: 30px;
                text-align: left;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>

    <div id="pantallaPrincipal"></div>
    <div id="scannerModal">
        <div class="scanner-frame-container">
            <video id="preview"></video>
            <div class="scanner-frame"></div>
        </div>
        <button id="closeScannerBtn" class="btn-danger" style="width: 90%; max-width: 400px; margin-top: 20px;">‚ùå Cerrar</button>
    </div>
<script>

    // Evitar el doble toque para hacer zoom en dispositivos m√≥viles
    document.addEventListener('dblclick', function(e) { e.preventDefault(); }, { passive: false });

    // Configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
        authDomain: "panel-logistica.firebaseapp.com",
        databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
        projectId: "panel-logistica",
        storageBucket: "panel-logistica.appspot.com",
        messagingSenderId: "38365879945",
        appId: "1:38365879945:web:e2f3590fe77f013dba3058"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Variables Globales
    let empleadoActual = null;
    let currentTarima = null;
    let codeReader = null;
    let scanning = false;
    let modo = "";
    let cantidadPiezasActual = null;

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const SUPER_ADMIN_GAFETE = "528734"; // Gafete para el primer administrador si la BD est√° vac√≠a

    // --- FUNCIONES GENERALES Y DE UI ---

    function updateStatus(message, type) {
        const statusDiv = document.getElementById("statusMessage");
        if (statusDiv) {
            statusDiv.textContent = message;
            statusDiv.className = `status-${type}`;
        }
    }

    function mostrarPantallaInicio() {
        const contenedor = document.getElementById("pantallaPrincipal");
        contenedor.innerHTML = `
            <div class="card">
                <h2>Recolecci√≥n de Tarimas</h2>
                <p>Seleccione una opci√≥n para comenzar</p>
                <button onclick="iniciarFlujo('recoleccion')" class="btn-primary">üì¶ Recolecci√≥n</button>
                <button onclick="iniciarFlujo('administracion')" class="btn-orange">‚öôÔ∏è Administraci√≥n</button>
                <button onclick="iniciarFlujoVerificacion()" class="btn-secondary">üîé Verificaci√≥n</button>
                <div id="statusMessage" style="margin-top: 20px;"></div>
            </div>
        `;
    }

    function cerrarSesion() {
        empleadoActual = null;
        currentTarima = null;
        cantidadPiezasActual = null;
        mostrarPantallaInicio();
    }

    // --- SISTEMA DE ACCESO Y AUTENTICACI√ìN ---

    function iniciarFlujo(flujo) {
        const titulos = {
            recoleccion: 'üì¶ Recolecci√≥n - Iniciar Sesi√≥n',
            administracion: '‚öôÔ∏è Administraci√≥n - Iniciar Sesi√≥n'
        };
        const contenedor = document.getElementById("pantallaPrincipal");
        contenedor.innerHTML = `
            <div class="card">
                <h2>${titulos[flujo]}</h2>
                <p>Escanee su gafete para continuar.</p>
                <div id="statusMessage"></div>
                <input type="text" id="gafeteInput" placeholder="Escanear o ingresar gafete">
                ${isMobile ? `<button id="btnEscGafete" class="btn-primary">üì∑ Escanear Gafete</button>` : ""}
                <button onclick="mostrarPantallaInicio()" class="btn-secondary">‚¨ÖÔ∏è Regresar</button>
            </div>
        `;
        updateStatus("Esperando escaneo de gafete...", 'info');
        const input = document.getElementById("gafeteInput");
        input.addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                verificarAcceso(input.value.trim(), flujo);
            }
        });

        if (isMobile) {
            document.getElementById("btnEscGafete").addEventListener("click", () => {
                iniciarEscaneo(`gafete-${flujo}`);
            });
        }
    }

    function verificarAcceso(gafete, flujo) {
        db.ref('users/' + gafete).once('value').then(snapshot => {
            const user = snapshot.val();
            let rol = user ? user.rol : null;

            db.ref('users').once('value').then(usersSnapshot => {
                // L√≥gica de Bootstrap: Si no hay usuarios en la BD, permite al super admin
                if (!usersSnapshot.exists() && gafete === SUPER_ADMIN_GAFETE) {
                    rol = 'administrador';
                }

                if (!rol) {
                    updateStatus("‚ùå Acceso denegado. Gafete no registrado.", 'error');
                    setTimeout(mostrarPantallaInicio, 2000);
                    return;
                }

                if (flujo === 'administracion' && rol !== 'administrador') {
                    updateStatus("‚ùå Acceso denegado. No tiene permisos de administrador.", 'error');
                    setTimeout(mostrarPantallaInicio, 2000);
                    return;
                }
                
                empleadoActual = { id: gafete, rol: rol, nombre: user ? user.nombre : 'Super Admin' };
                updateStatus(`¬°Hola, ${empleadoActual.nombre}!`, 'success');

                setTimeout(() => {
                    if (flujo === 'recoleccion') mostrarPantallaOpcionesRecoleccion();
                    else if (flujo === 'administracion') mostrarPantallaAdministracion();
                }, 1500);
            });
        }).catch(err => updateStatus('‚ùå Error de conexi√≥n con la base de datos.', 'error'));
    }

    // --- M√ìDULO DE ADMINISTRACI√ìN DE USUARIOS ---

    function mostrarPantallaAdministracion() {
        const contenedor = document.getElementById("pantallaPrincipal");
        contenedor.innerHTML = `
            <div class="card">
                <h2>‚öôÔ∏è Gesti√≥n de Usuarios</h2>
                <p>A√±ade, edita o elimina usuarios del sistema.</p>
                <div id="statusMessage"></div>
                <div style="text-align: left; margin-bottom: 20px;">
                    <input type="text" id="adminGafeteInput" placeholder="N√∫mero de Gafete">
                    <input type="text" id="adminNombreInput" placeholder="Nombre del Empleado">
                    <select id="adminRolSelect">
                        <option value="recolector">Recolector</option>
                        <option value="administrador">Administrador</option>
                    </select>
                </div>
                <button onclick="guardarUsuario()" class="btn-green">üíæ Guardar Usuario</button>
                <button onclick="cerrarSesion()" class="btn-danger">‚ùå Salir</button>
                <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 0;">
                <h3>Usuarios Registrados</h3>
                <ul id="listaUsuarios"></ul>
            </div>
        `;
        cargarUsuarios();
    }
    
    function cargarUsuarios() {
        const listaEl = document.getElementById("listaUsuarios");
        if (!listaEl) return;
        listaEl.innerHTML = '<li>Cargando...</li>';
        
        db.ref('users').once('value').then(snapshot => {
            if (!snapshot.exists()) {
                listaEl.innerHTML = '<li>No hay usuarios registrados.</li>';
                return;
            }
            let html = '';
            snapshot.forEach(userSnapshot => {
                const user = userSnapshot.val();
                const gafete = userSnapshot.key;
                html += `
                    <li>
                        <div>
                            <b>${user.nombre}</b> (${user.rol})
                            <br><small>Gafete: ${gafete}</small>
                        </div>
                        <div class="edit-delete-btns">
                            <button onclick="eliminarUsuario('${gafete}')" class="btn-danger">üóëÔ∏è</button>
                        </div>
                    </li>
                `;
            });
            listaEl.innerHTML = html;
        });
    }

    function guardarUsuario() {
        const gafete = document.getElementById('adminGafeteInput').value.trim();
        const nombre = document.getElementById('adminNombreInput').value.trim();
        const rol = document.getElementById('adminRolSelect').value;

        if (!gafete || !nombre) {
            updateStatus('‚ùå Por favor, complete todos los campos.', 'error');
            return;
        }

        db.ref('users/' + gafete).set({
            nombre: nombre,
            rol: rol
        }).then(() => {
            updateStatus('‚úÖ Usuario guardado correctamente.', 'success');
            document.getElementById('adminGafeteInput').value = '';
            document.getElementById('adminNombreInput').value = '';
            cargarUsuarios();
        }).catch(err => updateStatus('‚ùå Error al guardar el usuario.', 'error'));
    }

    function eliminarUsuario(gafete) {
        if (gafete === empleadoActual.id) {
            alert("No puedes eliminarte a ti mismo.");
            return;
        }
        if (confirm(`¬øEst√°s seguro de que quieres eliminar al usuario con gafete ${gafete}?`)) {
            db.ref('users/' + gafete).remove()
                .then(() => {
                    updateStatus('‚úÖ Usuario eliminado.', 'success');
                    cargarUsuarios();
                })
                .catch(err => updateStatus('‚ùå Error al eliminar el usuario.', 'error'));
        }
    }


    // --- M√ìDULO DE RECOLECCI√ìN ---

    function mostrarPantallaOpcionesRecoleccion() {
        const contenedor = document.getElementById("pantallaPrincipal");
        const turnoActual = determinarTurno();

        let adminButtons = `
            <button onclick="mostrarReportesYAnalisis()" class="btn-secondary">üìä Reportes y An√°lisis</button>
            <button onclick="solicitarAccesoEdicion()" class="btn-secondary">üìù Editar/Eliminar tarimas</button>
        `;

        contenedor.innerHTML = `
            <div class="card">
                <h2>üì¶ Recolecci√≥n</h2>
                <h3>Bienvenido, <b>${empleadoActual.nombre}</b></h3>
                <h4>Resumen del Turno (${turnoActual})</h4>
                <div id="resumenTurno" style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    Tarimas: <b id="tarimasRegistradas">0</b> | Cajas: <b id="cajasRegistradas">0</b>
                </div>
                <button onclick="crearNuevaTarima()" class="btn-green">üì¶ Crear Nueva Tarima</button>
                <button onclick="mostrarEdicionTarimasPropias()" class="btn-secondary">üìã Ver y Editar mis Tarimas</button>
                ${empleadoActual.rol === 'administrador' ? adminButtons : ''}
                <button onclick="cerrarSesion()" class="btn-danger">‚ùå Cerrar sesi√≥n</button>
            </div>
        `;
        actualizarResumenTurno();
    }
    
    function determinarTurno() {
        const hours = new Date().getHours();
        return (hours >= 6 && hours < 18) ? "Turno 1" : "Turno 2";
    }

    function actualizarResumenTurno() {
        const turnoActual = determinarTurno();
        db.ref("tarimas").orderByChild("empleadoId").equalTo(empleadoActual.id).once("value").then(snapshot => {
            let tarimasCount = 0;
            let cajasCount = 0;
            snapshot.forEach(tarimaSnapshot => {
                const tarima = tarimaSnapshot.val();
                if (tarima.turno === turnoActual) {
                    tarimasCount++;
                    if (tarima.cajas) cajasCount += Object.keys(tarima.cajas).length;
                }
            });
            const tarimasEl = document.getElementById("tarimasRegistradas");
            const cajasEl = document.getElementById("cajasRegistradas");
            if (tarimasEl && cajasEl) {
                tarimasEl.textContent = tarimasCount;
                cajasEl.textContent = cajasCount;
            }
        });
    }

    function crearNuevaTarima() {
        const turno = determinarTurno();
        db.ref("tarimas").orderByKey().limitToLast(1).once("value").then(snapshot => {
            let nextIdNumber = 1;
            if (snapshot.exists()) {
                const lastTarimaId = Object.keys(snapshot.val())[0];
                const lastIdNumber = parseInt(lastTarimaId.split('-')[1]);
                if (!isNaN(lastIdNumber)) nextIdNumber = lastIdNumber + 1;
            }
            const idTarima = "TAR-" + String(nextIdNumber).padStart(3, '0');
            currentTarima = idTarima;
            cantidadPiezasActual = null;

            db.ref("tarimas/" + idTarima).set({
                id: idTarima,
                empleadoId: empleadoActual.id,
                fechaCreacion: new Date().toISOString(),
                turno: turno,
                cajas: {},
                estado: 'pendiente'
            }).then(() => mostrarFormularioTarima(idTarima));
        });
    }
    
    function mostrarFormularioTarima(idTarima) {
        const contenedor = document.getElementById("pantallaPrincipal");
        contenedor.innerHTML = `
            <div class="card">
                <h3>Tarima: ${idTarima}</h3>
                <h4>Cantidad actual: <span id="cantidadActual">${cantidadPiezasActual || 'Sin seleccionar'}</span></h4>
                <div id="statusMessage"></div>
                <input type="text" id="codigoCaja" placeholder="Escanear Cantidad o C√≥digo BX">
                ${isMobile ? `<button id="btnEscCaja" class="btn-primary">üì∑ Escanear</button>` : ""}
                <h4>Resumen</h4>
                <div id="resumenTarima" style="padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">Cajas: 0 | Piezas: 0</div>
                <h4>Cajas Registradas</h4>
                <ul id="listaCajas"></ul>
                <button onclick="terminarRegistroTarima('${idTarima}')" class="btn-orange">‚úÖ Terminar Registro</button>
                <button onclick="cancelarCreacionTarima('${idTarima}')" class="btn-danger">‚ùå Cancelar Tarima</button>
            </div>
        `;
        updateStatus("Escanee un c√≥digo de cantidad (1, 5, 6, 12, 24, 34) para empezar.", 'info');

        if (isMobile) {
            document.getElementById("btnEscCaja").addEventListener("click", () => iniciarEscaneo("caja"));
        }
        document.getElementById("codigoCaja").addEventListener("keypress", function(e) {
            if (e.key === "Enter") procesarEscaneo(this.value.trim(), idTarima);
        });
        actualizarResumenTarima(idTarima);
    }
    
    function procesarEscaneo(valor, idTarima) {
        const input = document.getElementById("codigoCaja");
        const cantidadesValidas = [1, 5, 6, 12, 24, 34];
        const cantidadInput = parseInt(valor);

        if (cantidadesValidas.includes(cantidadInput)) {
            cantidadPiezasActual = cantidadInput;
            document.getElementById("cantidadActual").textContent = cantidadPiezasActual;
            updateStatus(`‚úÖ Cantidad establecida a ${cantidadPiezasActual}. Ahora escanee el c√≥digo BX.`, 'success');
            input.value = "";
            return;
        }
        
        if (!valor.toUpperCase().startsWith('BX')) {
            updateStatus("‚ùå Error: El c√≥digo de caja debe empezar con 'BX'.", 'error');
            input.value = "";
            return;
        }

        if (cantidadPiezasActual === null) {
            updateStatus("‚ùå Error: Primero debe escanear la cantidad de piezas (1, 5, 6, 12, 24, 34).", 'error');
            input.value = "";
            return;
        }

        const codigoCaja = valor.trim();
        db.ref("tarimas").once("value").then(snapshot => {
            let bxEncontrado = false;
            let tarimaAnterior = null;
            snapshot.forEach(tarimaSnapshot => {
                if (tarimaSnapshot.val().cajas) {
                    const caja = Object.values(tarimaSnapshot.val().cajas).find(c => c.codigoCaja === codigoCaja);
                    if (caja) {
                        bxEncontrado = true;
                        tarimaAnterior = tarimaSnapshot.key;
                    }
                }
            });

            if (bxEncontrado) {
                updateStatus(`‚ùå Error: Este BX ya fue agregado a la tarima: ${tarimaAnterior}`, 'error');
                input.value = "";
                return;
            }

            const cajaTemp = {
                codigoCaja: codigoCaja,
                numeroOrden: codigoCaja.substring(2, 12),
                cantidadPiezas: cantidadPiezasActual,
                empleadoId: empleadoActual.id,
                turno: determinarTurno(),
                timestamp: new Date().toISOString()
            };
            db.ref(`tarimas/${idTarima}/cajas`).push().set(cajaTemp).then(() => {
                updateStatus(`üì¶ Caja ${codigoCaja} (${cantidadPiezasActual} pz) guardada.`, 'success');
                actualizarResumenTarima(idTarima);
            });
        });
        input.value = "";
    }

    function actualizarResumenTarima(idTarima) {
        db.ref(`tarimas/${idTarima}/cajas`).once("value").then(snapshot => {
            const cajas = snapshot.val() || {};
            const totalCajas = Object.keys(cajas).length;
            let totalPiezas = 0;
            let lista = "";
            const cajasPorOrden = {};
            
            snapshot.forEach(cajaSnapshot => {
                const caja = cajaSnapshot.val();
                totalPiezas += caja.cantidadPiezas || 0;
                if (!cajasPorOrden[caja.numeroOrden]) cajasPorOrden[caja.numeroOrden] = [];
                cajasPorOrden[caja.numeroOrden].push({ id: cajaSnapshot.key, ...caja });
            });

            for (const orden in cajasPorOrden) {
                const totalPiezasOrden = cajasPorOrden[orden].reduce((sum, c) => sum + c.cantidadPiezas, 0);
                lista += `
                    <li>
                        <div>Orden: ${orden} | Piezas: ${totalPiezasOrden}</div>
                        <div class="edit-delete-btns">
                            ${cajasPorOrden[orden].map(c => `<button onclick="eliminarCaja('${idTarima}', '${c.id}')" class="btn-danger list-item-btn">${c.codigoCaja} üóëÔ∏è</button>`).join("")}
                        </div>
                    </li>
                `;
            }
            const resumenEl = document.getElementById("resumenTarima");
            const listaEl = document.getElementById("listaCajas");
            if (resumenEl && listaEl) {
                resumenEl.innerText = `Cajas: ${totalCajas} | Piezas: ${totalPiezas}`;
                listaEl.innerHTML = lista;
            }
            actualizarResumenTurno();
        });
    }

    function eliminarCaja(idTarima, idCaja) {
        if (confirm("¬øEst√°s seguro de que quieres eliminar esta caja?")) {
            db.ref(`tarimas/${idTarima}/cajas/${idCaja}`).remove()
                .then(() => {
                    updateStatus("Caja eliminada correctamente.", 'success');
                    actualizarResumenTarima(idTarima);
                });
        }
    }
    
    function terminarRegistroTarima(idTarima) {
        mostrarPantallaOpcionesRecoleccion();
        alert(`‚úÖ Registro de Tarima ${idTarima} Finalizado.`);
    }

    function cancelarCreacionTarima(idTarima) {
        if (confirm("¬øEst√° seguro de que desea cancelar? Se eliminar√° esta tarima.")) {
            db.ref(`tarimas/${idTarima}`).remove().then(() => {
                mostrarPantallaOpcionesRecoleccion();
            });
        }
    }
    
    // --- EDICI√ìN Y GESTI√ìN DE TARIMAS ---
    
    function solicitarAccesoEdicion() {
        const password = prompt("Ingrese la contrase√±a de administrador para editar/eliminar tarimas:");
        if (password === "BORRAR25") mostrarEdicionTarimasAdmin();
        else alert("Contrase√±a incorrecta.");
    }

    function mostrarEdicionTarimasPropias() {
        const contenedor = document.getElementById("pantallaPrincipal");
        contenedor.innerHTML = `
            <div class="card">
                <h2>üìù Mis Tarimas Creadas</h2>
                <button onclick="mostrarPantallaOpcionesRecoleccion()" class="btn-primary">‚¨ÖÔ∏è Regresar</button>
                <div id="statusMessage"></div>
                <ul id="listaEdicionTarimas"></ul>
            </div>
        `;
        cargarListaEdicionTarimas(true); // true para 'solo propias'
    }

    function mostrarEdicionTarimasAdmin() {
        const contenedor = document.getElementById("pantallaPrincipal");
        contenedor.innerHTML = `
            <div class="card">
                <h2>üìù Editar/Eliminar Todas las Tarimas</h2>
                <button onclick="mostrarPantallaOpcionesRecoleccion()" class="btn-primary">‚¨ÖÔ∏è Regresar</button>
                <div id="statusMessage"></div>
                <ul id="listaEdicionTarimas"></ul>
            </div>
        `;
        cargarListaEdicionTarimas(false); // false para 'todas'
    }
    
    function cargarListaEdicionTarimas(soloPropias) {
        updateStatus("Cargando tarimas...", 'info');
        const query = soloPropias ? db.ref("tarimas").orderByChild("empleadoId").equalTo(empleadoActual.id) : db.ref("tarimas");
        
        query.once("value").then(snapshot => {
            let lista = "";
            if (!snapshot.exists()) {
                lista = `<li>No se encontraron tarimas.</li>`;
            } else {
                snapshot.forEach(tarimaSnapshot => {
                    const tarima = tarimaSnapshot.val();
                    const fecha = new Date(tarima.fechaCreacion).toLocaleString();
                    lista += `
                        <li>
                            <div>
                                Tarima: ${tarima.id} | Estado: ${tarima.estado}
                                <br><small>Creada el ${fecha}</small>
                            </div>
                            <div class="edit-delete-btns">
                                <button onclick="editarTarima('${tarima.id}')" class="btn-primary">‚úèÔ∏è</button>
                                <button onclick="eliminarTarima('${tarima.id}', ${soloPropias})" class="btn-danger">üóëÔ∏è</button>
                            </div>
                        </li>
                    `;
                });
            }
            document.getElementById("listaEdicionTarimas").innerHTML = lista;
            updateStatus("Lista cargada.", 'success');
        });
    }

    function editarTarima(idTarima) {
        currentTarima = idTarima;
        mostrarFormularioTarima(idTarima);
        updateStatus(`Editando tarima ${idTarima}`, 'info');
    }

    function eliminarTarima(idTarima, soloPropias) {
        if (confirm(`¬øEst√° seguro de eliminar la tarima ${idTarima}?`)) {
            db.ref(`tarimas/${idTarima}`).remove()
                .then(() => {
                    alert(`La tarima ${idTarima} ha sido eliminada.`);
                    if (soloPropias) mostrarEdicionTarimasPropias();
                    else mostrarEdicionTarimasAdmin();
                });
        }
    }

    // --- M√ìDULO DE VERIFICACI√ìN ---

    function iniciarFlujoVerificacion() {
        const contenedor = document.getElementById("pantallaPrincipal");
        contenedor.innerHTML = `
            <div class="card">
                <h2>üîé Verificaci√≥n de BX</h2>
                <p>Escanee un c√≥digo BX para ver su informaci√≥n.</p>
                <div id="statusMessage"></div>
                <input type="text" id="verificacionInput" placeholder="Escanear BX-XXX">
                ${isMobile ? `<button id="btnEscVerificacion" class="btn-secondary">üì∑ Escanear</button>` : ""}
                <button onclick="mostrarPantallaInicio()" class="btn-primary">‚¨ÖÔ∏è Regresar</button>
            </div>
        `;
        updateStatus("Esperando escaneo de BX...", 'info');
        const input = document.getElementById("verificacionInput");
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") buscarYMostrarInfoBX(input.value.trim());
        });
        if (isMobile) {
            document.getElementById("btnEscVerificacion").addEventListener("click", () => iniciarEscaneo("verificacion"));
        }
    }

    function buscarYMostrarInfoBX(codigoCaja) {
        if (!codigoCaja.toUpperCase().startsWith('BX')) {
            updateStatus("‚ùå Error: El c√≥digo de caja debe empezar con 'BX'.", 'error');
            return;
        }
        db.ref("tarimas").once("value").then(snapshot => {
            let tarimaEncontrada = null;
            snapshot.forEach(tarimaSnapshot => {
                const tarima = tarimaSnapshot.val();
                if (tarima.cajas && Object.values(tarima.cajas).find(c => c.codigoCaja === codigoCaja)) {
                    tarimaEncontrada = tarima;
                }
            });
            if (!tarimaEncontrada) {
                updateStatus("‚ùå Error: Caja no encontrada en ninguna tarima.", 'error');
            } else {
                mostrarInfoTarima(tarimaEncontrada, codigoCaja);
            }
        });
    }

    function mostrarInfoTarima(tarimaData, codigoCajaEscaneado) {
        const contenedor = document.getElementById("pantallaPrincipal");
        const totalCajas = Object.keys(tarimaData.cajas || {}).length;
        const cajasHtml = Object.values(tarimaData.cajas || {}).map(caja => {
            const highlight = caja.codigoCaja === codigoCajaEscaneado ? 'style="background-color: rgba(0, 122, 255, 0.5);"' : '';
            return `<li ${highlight}>${caja.codigoCaja}</li>`;
        }).join('');
        
        contenedor.innerHTML = `
            <div class="card">
                <h2>üîé Informaci√≥n de Tarima</h2>
                <h3>Tarima: <b>${tarimaData.id}</b></h3>
                <p><b>Recolector:</b> ${tarimaData.empleadoId}</p>
                <p><b>Estado:</b> ${tarimaData.estado}</p>
                <p><b>Total de cajas:</b> ${totalCajas}</p>
                <hr style="border-color: rgba(255,255,255,0.2); margin: 20px 0;">
                <h4>Cajas en la Tarima:</h4>
                <ul id="listaInfoCajas" style="max-height: 200px; overflow-y: auto;">${cajasHtml}</ul>
                <div id="statusMessage"></div>
                <button onclick="iniciarFlujoVerificacion()" class="btn-secondary">üîé Verificar otro BX</button>
                <button onclick="mostrarPantallaInicio()" class="btn-primary">‚¨ÖÔ∏è Regresar</button>
            </div>
        `;
        updateStatus(`Informaci√≥n para el BX: ${codigoCajaEscaneado}`, 'info');
    }
    
    // --- REPORTES (SOLO ADMIN) ---
    // (Esta es una versi√≥n simplificada, se puede expandir como en tu c√≥digo original)
    function mostrarReportesYAnalisis() {
        alert("Funci√≥n de Reportes en construcci√≥n.");
        mostrarPantallaOpcionesRecoleccion();
    }


    // --- FUNCIONALIDAD DEL ESC√ÅNER ---

    async function iniciarEscaneo(tipo) {
        if (scanning) return;
        modo = tipo;
        scanning = true;
        document.getElementById('scannerModal').classList.add('active');
        codeReader = new ZXing.BrowserBarcodeReader();
        updateStatus("C√°mara activa. Escaneando...", 'info');
        
        try {
            const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'preview');
            const valor = result.text.trim();
            detenerCamara();
            
            if (modo.startsWith("gafete-")) {
                const flujo = modo.split('-')[1];
                verificarAcceso(valor, flujo);
            } else if (modo === "caja") {
                procesarEscaneo(valor, currentTarima);
            } else if (modo === "verificacion") {
                buscarYMostrarInfoBX(valor);
            }
        } catch (err) {
            console.error("Error de escaneo:", err);
            updateStatus("‚ùå No se pudo iniciar la c√°mara o leer el c√≥digo.", 'error');
            detenerCamara();
        }
    }

    function detenerCamara() {
        if (codeReader) codeReader.reset();
        document.getElementById('scannerModal').classList.remove('active');
        scanning = false;
    }

    // --- INICIALIZACI√ìN ---

    document.addEventListener('DOMContentLoaded', () => {
        mostrarPantallaInicio();
        document.getElementById('closeScannerBtn').addEventListener('click', detenerCamara);
    });

</script>
</body>
</html>