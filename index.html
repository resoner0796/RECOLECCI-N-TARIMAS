<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Recolecci√≥n - Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <style>
        /* Estilos generales y de tarjeta */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #000000;
            color: #FFFFFF;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
        }
        .card { 
            background: #1c1c1e;
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
            width: 90%;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        /* Estilos de inputs y botones */
        input, select { 
            padding: 12px;
            width: calc(100% - 24px);
            margin: 10px 0;
            font-size: 16px;
            border-radius: 10px;
            border: 1px solid #3a3a3c;
            background: #2c2c2e;
            color: #FFFFFF;
            box-sizing: border-box;
        }
        input::placeholder {
            color: #8e8e93;
        }
        button { 
            padding: 15px 20px;
            margin: 10px 0;
            cursor: pointer;
            font-size: 16px;
            border-radius: 10px;
            border: none;
            width: 100%;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        button.btn-primary { 
            background-color: #007AFF;
            color: #FFFFFF;
        }
        button.btn-green { 
            background-color: #4CAF50;
            color: #FFFFFF;
        }
        button.btn-orange { 
            background-color: #ffc107;
            color: #000000;
        }
        button.btn-danger {
            background-color: #ff3b30;
            color: #FFFFFF;
        }
        button.btn-secondary {
            background-color: #6c757d;
            color: #FFFFFF;
        }
        button:active {
            filter: brightness(0.9);
        }
        /* Estilos de t√≠tulos y listas */
        h2, h3, h4 { margin: 10px 0; }
        ul { padding-left: 0; list-style: none; }
        li { 
            margin-bottom: 10px;
            background: #2c2c2e;
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            text-align: left;
            overflow: hidden;
            word-wrap: break-word;
        }
        small { color: #8e8e93; }
        #statusMessage { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 6px; 
            font-weight: bold; 
            text-align: center; 
        }
        .status-success { background-color: #34c759; color: #FFFFFF; }
        .status-info { background-color: #5ac8fa; color: #FFFFFF; }
        .status-error { background-color: #ff3b30; color: #FFFFFF; }
        
        .list-item-btn {
            width: auto;
            padding: 5px 10px;
            margin: 0;
            float: right;
        }
        .edit-delete-btns {
            float: right;
            display: inline-block;
        }
        .edit-delete-btns button {
            width: auto;
            display: inline-block;
            padding: 5px 10px;
            margin: 0 2px;
        }
        
        /* Estilos del modal y el marco de escaneo */
        #scannerModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
        }
        #scannerModal.active {
            display: flex;
        }
        .scanner-frame-container {
            position: relative;
            width: 90%;
            max-width: 400px;
            aspect-ratio: 16 / 9;
            border: 2px solid #007AFF;
            border-radius: 10px;
            overflow: hidden;
        }
        #preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .scanner-frame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
        }
        .scanner-frame::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #ff3b30;
            transform: translateY(-50%);
            animation: scan-line 2s infinite;
        }
        @keyframes scan-line {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }

        /* Bloque de estilos para Reportes y An√°lisis */
        .report-section {
            text-align: left;
            margin-top: 20px;
            border-top: 1px solid #3a3a3c;
            padding-top: 20px;
        }
        .report-filters {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }
        @media (min-width: 600px) {
            .report-filters {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .report-results-list li {
            background-color: #2c2c2e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        /**
         * @description NUEVO BLOQUE: Estilos para escritorio (min-width: 768px)
         * Se agreg√≥ un dise√±o m√°s formal y espacioso para pantallas grandes.
         */
        @media (min-width: 768px) {
            body {
                background-color: #121212;
            }
            .card {
                max-width: 1000px; /* Aumenta el ancho m√°ximo para aprovechar el espacio */
                padding: 40px;
            }
            h2 {
                font-size: 2.5em;
            }
            h3, h4 {
                font-size: 1.5em;
            }
            input, select {
                padding: 15px;
                font-size: 18px;
            }
            button {
                padding: 18px 25px;
                font-size: 18px;
            }
            /* Layout de 2 columnas para el dashboard y reportes */
            .dashboard-container, .report-container {
                display: grid;
                grid-template-columns: 1fr 2fr;
                gap: 30px;
                text-align: left;
            }
            .dashboard-container .card, .report-container .card {
                margin: 0;
            }
            .report-filters {
                grid-template-columns: repeat(3, 1fr);
            }
            .report-results-list li {
                padding: 20px;
            }
            #dashboardResumen {
                display: flex;
                justify-content: flex-start;
            }
            #dashboardResumen div {
                min-width: 150px;
                padding: 20px;
            }
            #dashboardResumen h4 {
                font-size: 1.2em;
            }
            #dashboardResumen h2 {
                font-size: 2.5em;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>

    <div id="pantalla5"></div>
    <div id="scannerModal">
        <div class="scanner-frame-container">
            <video id="preview"></video>
            <div class="scanner-frame"></div>
        </div>
        <button id="closeScannerBtn" class="btn-danger" style="width: 90%; max-width: 400px; margin-top: 20px;">‚ùå Cerrar</button>
    </div>
    <script>
    
        // Evitar el doble toque para hacer zoom en dispositivos m√≥viles
        document.addEventListener('dblclick', function(e) {
            e.preventDefault();
        }, { passive: false });

        const firebaseConfig = {
            apiKey: "AIzaSyCPTEu73s2rVIm2VsdTk59kVIOyi1jeyu8",
            authDomain: "panel-logistica.firebaseapp.com",
            databaseURL: "https://panel-logistica-default-rtdb.firebaseio.com",
            projectId: "panel-logistica",
            storageBucket: "panel-logistica.appspot.com",
            messagingSenderId: "38365879945",
            appId: "1:38365879945:web:e2f3590fe77f013dba3058"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let empleadoActual = null;
        let currentTarima = null;
        let codeReader = null;
        let scanning = false;
        let modo = "";
        let cantidadPiezasActual = null;
        let confirmadorActual = null;
        let tarimaAConfirmar = null;

        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        // Listas de acceso
        const administradores = ["528734", "626365"];
        const recolectores = ["703329"];

        function updateStatus(message, type) {
            const statusDiv = document.getElementById("statusMessage");
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status-${type}`;
            }
        }

        function mostrarPantallaInicio() {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card">
                    <h2>Seleccione su funci√≥n</h2>
                    <button onclick="iniciarFlujoRecoleccion()" class="btn-primary">üì¶ Recolecci√≥n</button>
                    <button onclick="iniciarFlujoConfirmacion()" class="btn-green">‚úÖ Confirmaci√≥n</button>
                    <button onclick="iniciarFlujoVerificacion()" class="btn-secondary">üîé Verificaci√≥n</button>
                    <div id="statusMessage" style="margin-top: 20px;"></div>
                </div>
            `;
        }

        function iniciarFlujoRecoleccion() {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card">
                    <h2>üì¶ Recolecci√≥n - Iniciar sesi√≥n</h2>
                    <p>Escanee su gafete para registrarse.</p>
                    <div id="statusMessage"></div>
                    <input type="text" id="gafeteInput" placeholder="Escanear gafete">
                    ${isMobile ? `<button id="btnEscGafete" class="btn-primary">üì∑ Iniciar escaneo</button>` : ""}
                    <button onclick="mostrarPantallaInicio()" class="btn-secondary">‚¨ÖÔ∏è Regresar</button>
                </div>
            `;
            updateStatus("Esperando escaneo de gafete...", 'info');
            const input = document.getElementById("gafeteInput");
            input.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    verificarAccesoRecoleccion(input.value.trim());
                }
            });

            if (isMobile) {
                document.getElementById("btnEscGafete").addEventListener("click", () => {
                    iniciarEscaneo("gafeteRecoleccion");
                });
            }
        }

        function verificarAccesoRecoleccion(gafete) {
            empleadoActual = gafete;
            let rol = null;
            if (administradores.includes(gafete)) {
                rol = 'administrador';
            } else if (recolectores.includes(gafete)) {
                rol = 'recolector';
            }

            if (rol) {
                updateStatus(`¬°Hola, ${rol === 'administrador' ? 'Administrador' : 'Recolector'}!`, 'success');
                setTimeout(() => mostrarPantallaOpcionesRecoleccion(rol), 1500);
            } else {
                updateStatus("‚ùå Acceso denegado. Gafete no registrado para recolecci√≥n.", 'error');
                setTimeout(() => mostrarPantallaInicio(), 2000);
            }
        }

        /**
         * @description NUEVO BLOQUE: Funcionalidades para Recolectores y Administradores.
         * Se agreg√≥ un Dashboard de Productividad y un bot√≥n de "Ver mis Tarimas" (para Recolectores)
         * Se agreg√≥ un bot√≥n de "Reportes y An√°lisis" y "Dashboard Admin" (solo para Administradores)
         */
        function mostrarPantallaOpcionesRecoleccion(rol) {
            const contenedor = document.getElementById("pantalla5");
            const turnoActual = determinarTurno();

            let buttonsHtml = "";
            let adminButtons = `
                <button onclick="mostrarTarimasCreadas()" class="btn-secondary">üìã Ver todas las tarimas</button>
                <button onclick="mostrarAnalisisDiscrepancias()" class="btn-secondary">üîé Ver Discrepancias</button>
                <button onclick="mostrarReportesYAnalisis()" class="btn-secondary">üìä Reportes y An√°lisis</button>
                <button onclick="mostrarDashboardAdmin()" class="btn-secondary">üìà Dashboard Admin</button>
                <button onclick="solicitarAccesoEdicion()" class="btn-secondary">üìù Editar/Eliminar tarimas</button>
            `;

            if (rol === 'administrador') {
                buttonsHtml += `
                    <button onclick="crearNuevaTarima()" class="btn-green">üì¶ Crear Nueva Tarima</button>
                    ${adminButtons}
                `;
            } else if (rol === 'recolector') {
                buttonsHtml += `
                    <button onclick="crearNuevaTarima()" class="btn-green">üì¶ Crear Nueva Tarima</button>
                    <button onclick="mostrarEdicionTarimasRecolector()" class="btn-secondary">üìã Ver y Editar mis Tarimas</button>
                `;
            }

            contenedor.innerHTML = `
                <div class="card">
                    <h2>üì¶ Recolecci√≥n</h2>
                    <h3>Empleado: <b>${empleadoActual}</b></h3>
                    <h4>Resumen de Turno (${turnoActual})</h4>
                    <div id="resumenTurno" style="padding: 10px; background: #2c2c2e; border-radius: 8px;">
                        Tarimas: <b id="tarimasRegistradas">0</b> | Cajas: <b id="cajasRegistradas">0</b>
                    </div>
                    ${buttonsHtml}
                    <button onclick="cerrarSesionRecoleccion()" class="btn-danger">‚ùå Cerrar sesi√≥n</button>
                    <div id="tarimaContainer"></div>
                </div>
            `;
            
            actualizarResumenTurno();
        }

        function cerrarSesionRecoleccion() {
            empleadoActual = null;
            currentTarima = null;
            cantidadPiezasActual = null;
            updateStatus("Sesi√≥n de recolecci√≥n cerrada.", 'info');
            mostrarPantallaInicio();
        }

        function iniciarFlujoConfirmacion() {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card">
                    <h2>‚úÖ Confirmaci√≥n de Tarima</h2>
                    <p>Paso 1: Escanee su gafete para registrarse como confirmador.</p>
                    <div id="statusMessage"></div>
                    <input type="text" id="confirmadorInput" placeholder="Escanear gafete">
                    ${isMobile ? `<button id="btnEscConfirmador" class="btn-primary">üì∑ Iniciar escaneo</button>` : ""}
                    <button onclick="mostrarPantallaInicio()" class="btn-secondary">‚¨ÖÔ∏è Regresar</button>
                </div>
            `;
            updateStatus("Esperando escaneo de gafete...", 'info');
            const input = document.getElementById("confirmadorInput");
            input.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    confirmadorActual = input.value.trim();
                    input.value = "";
                    updateStatus(`Confirmador: ${confirmadorActual} registrado.`, 'success');
                    setTimeout(() => mostrarPantallaConfirmacionCaja(), 1500);
                }
            });

            if (isMobile) {
                document.getElementById("btnEscConfirmador").addEventListener("click", () => {
                    iniciarEscaneo("confirmador");
                });
            }
        }

        /**
         * @description NUEVO BLOQUE: L√≥gica para el Dashboard de Productividad Personal
         * Se agreg√≥ la l√≥gica para contar las tarimas y cajas del empleado actual y turno actual.
         */
        function actualizarResumenTurno() {
            const turnoActual = determinarTurno();
            db.ref("tarimas").orderByChild("empleadoId").equalTo(empleadoActual).once("value").then(snapshot => {
                let tarimasCount = 0;
                let cajasCount = 0;
                snapshot.forEach(tarimaSnapshot => {
                    const tarima = tarimaSnapshot.val();
                    if (tarima.turno === turnoActual) {
                        tarimasCount++;
                        if (tarima.cajas) {
                            cajasCount += Object.keys(tarima.cajas).length;
                        }
                    }
                });
                const tarimasRegistradasElement = document.getElementById("tarimasRegistradas");
                const cajasRegistradasElement = document.getElementById("cajasRegistradas");
                if (tarimasRegistradasElement && cajasRegistradasElement) {
                    tarimasRegistradasElement.textContent = tarimasCount;
                    cajasRegistradasElement.textContent = cajasCount;
                }
            });
        }

        function determinarTurno() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            if ((hours > 6 || (hours === 6 && minutes >= 30)) && (hours < 18 || (hours === 18 && minutes < 30))) {
                return "Turno 1";
            } else {
                return "Turno 2";
            }
        }

        async function iniciarEscaneo(tipo) {
            if (scanning) return;
            modo = tipo;
            scanning = true;
            const scannerModal = document.getElementById("scannerModal");
            scannerModal.classList.add('active');
            
            codeReader = new ZXing.BrowserBarcodeReader();
            updateStatus("C√°mara activa. Escaneando...", 'info');
            
            try {
                const constraints = {
                    video: {
                        facingMode: "environment"
                    }
                };

                const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'preview', constraints);
                
                if (modo === "gafeteRecoleccion") {
                    verificarAccesoRecoleccion(result.text.trim());
                } else if (modo === "confirmador") {
                    confirmadorActual = result.text.trim();
                    updateStatus(`Confirmador: ${confirmadorActual} registrado.`, 'success');
                    setTimeout(() => mostrarPantallaConfirmacionCaja(), 1500);
                } else if (modo === "caja") {
                    procesarEscaneo(result.text.trim(), currentTarima);
                } else if (modo === "cajaConfirmacion") {
                    buscarTarimaPorCaja(result.text.trim());
                } else if (modo === "verificacion") {
                    buscarYMostrarInfoBX(result.text.trim());
                }
            } catch (err) {
                console.error("Error al iniciar la c√°mara:", err);
                updateStatus("‚ùå No se pudo iniciar la c√°mara. Verifique que los permisos est√©n habilitados.", 'error');
            } finally {
                detenerCamara();
            }
        }

        function detenerCamara() {
            if (codeReader) {
                codeReader.reset();
            }
            const scannerModal = document.getElementById("scannerModal");
            scannerModal.classList.remove('active');
            scanning = false;
        }

        function crearNuevaTarima() {
            const turno = determinarTurno();
            db.ref("tarimas").orderByKey().limitToLast(1).once("value").then(snapshot => {
                let nextIdNumber = 1;
                if (snapshot.exists()) {
                    const lastTarimaId = Object.keys(snapshot.val())[0];
                    const lastIdNumber = parseInt(lastTarimaId.split('-')[1]);
                    if (!isNaN(lastIdNumber)) {
                        nextIdNumber = lastIdNumber + 1;
                    }
                }
                const idTarima = "TAR-" + String(nextIdNumber).padStart(3, '0');
                currentTarima = idTarima;
                cantidadPiezasActual = null;

                db.ref("tarimas/" + idTarima).set({
                    id: idTarima,
                    empleadoId: empleadoActual,
                    fechaCreacion: new Date().toISOString(),
                    turno: turno,
                    cajas: {},
                    estado: 'pendiente' // Nuevo campo de estado
                }).then(() => {
                    mostrarFormularioTarima(idTarima);
                }).catch(error => {
                    console.error("Error al crear la tarima:", error);
                    updateStatus("‚ùå Error al crear la tarima. Intente de nuevo.", 'error');
                });
            });
        }

        function mostrarFormularioTarima(idTarima) {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card">
                    <h3>Tarima: ${idTarima}</h3>
                    <h4>Cantidad actual: <span id="cantidadActual">${cantidadPiezasActual || 'Sin seleccionar'}</span></h4>
                    <div id="statusMessage"></div>
                    <input type="text" id="codigoCaja" placeholder="Escanear BX o Cantidad (1, 5, 6, 12, 24, 34)">
                    ${isMobile ? `<button id="btnEscCaja" class="btn-primary">üì∑ Iniciar escaneo</button>` : ""}
                    <h4>Resumen</h4>
                    <div id="resumenTarima">Cajas: 0 | Piezas: 0</div>
                    <h4>Cajas registradas</h4>
                    <ul id="listaCajas"></ul>
                    <button onclick="terminarRegistroTarima('${idTarima}')" class="btn-orange">‚úÖ Terminar Registro</button>
                    <button onclick="cancelarCreacionTarima('${idTarima}')" class="btn-danger">‚ùå Cancelar</button>
                </div>
            `;
            updateStatus("Escanear el c√≥digo de cantidad (1, 5, 6, 12, 24, 34) para iniciar.", 'info');

            if (isMobile) {
                document.getElementById("btnEscCaja").addEventListener("click", () => {
                    iniciarEscaneo("caja");
                });
            }

            configurarEscaneo(idTarima);
            actualizarResumenTarima(idTarima);
        }

        function cancelarCreacionTarima(idTarima) {
            if (confirm("¬øEst√° seguro de que desea cancelar? Se eliminar√° esta tarima y todos los datos que haya capturado en ella.")) {
                db.ref(`tarimas/${idTarima}`).remove()
                    .then(() => {
                        updateStatus("‚úÖ Creaci√≥n de tarima cancelada y eliminada.", 'success');
                        mostrarPantallaOpcionesRecoleccion(administradores.includes(empleadoActual) ? 'administrador' : 'recolector');
                    })
                    .catch(error => {
                        console.error("Error al cancelar la tarima:", error);
                        updateStatus("‚ùå Error al cancelar. Intente de nuevo.", 'error');
                    });
            }
        }

        function procesarEscaneo(valor, idTarima) {
            const input = document.getElementById("codigoCaja");
            const cantidadesValidas = [1, 5, 6, 12, 24, 34];
            const cantidadInput = parseInt(valor);
            if (cantidadesValidas.includes(cantidadInput)) {
                cantidadPiezasActual = cantidadInput;
                document.getElementById("cantidadActual").textContent = cantidadPiezasActual;
                updateStatus(`‚úÖ Cantidad establecida a ${cantidadPiezasActual}. Ahora escanee el c√≥digo BX.`, 'success');
                input.value = "";
                return;
            }
            if (!valor.startsWith('bx', 'BX')) {
                updateStatus("‚ùå Error: El c√≥digo de caja debe empezar con 'BX'. Caja no agregada.", 'error');
                input.value = "";
                return;
            }
            if (cantidadPiezasActual === null) {
                updateStatus("‚ùå Error: Primero debe escanear la cantidad de piezas (1, 5, 6, 12, 24, 34).", 'error');
                input.value = "";
                return;
            }
            const codigoCaja = valor.trim();
            const numeroOrden = codigoCaja.substring(2, 12);

            db.ref("tarimas").once("value").then(snapshot => {
                let bxEncontrado = false;
                let tarimaAnterior = null;
                snapshot.forEach(tarimaSnapshot => {
                    const tarima = tarimaSnapshot.val();
                    if (tarima.cajas) {
                        for (let key in tarima.cajas) {
                            if (tarima.cajas[key].codigoCaja === codigoCaja) {
                                bxEncontrado = true;
                                tarimaAnterior = tarima.id;
                                break;
                            }
                        }
                    }
                    if (bxEncontrado) {
                        return true;
                    }
                });

                if (bxEncontrado) {
                    if (tarimaAnterior === idTarima) {
                        updateStatus("‚ùå Error: Este BX ya fue agregado a esta tarima.", 'error');
                    } else {
                        updateStatus(`‚ùå Error: Este BX ya fue agregado a la tarima: ${tarimaAnterior}`, 'error');
                    }
                    input.value = "";
                    return;
                }
                const cajaTemp = {
                    codigoCaja: codigoCaja,
                    numeroOrden: numeroOrden,
                    cantidadPiezas: cantidadPiezasActual,
                    empleadoId: empleadoActual,
                    turno: determinarTurno(),
                    timestamp: new Date().toISOString()
                };
                const cajaId = db.ref(`tarimas/${idTarima}/cajas`).push().key;

                db.ref(`tarimas/${idTarima}/cajas/${cajaId}`).set(cajaTemp)
                    .then(() => {
                        updateStatus(`üì¶ Caja ${codigoCaja} (${cantidadPiezasActual} pz) guardada correctamente.`, 'success');
                        actualizarResumenTarima(idTarima);
                    })
                    .catch((error) => {
                        console.error("Error al guardar la caja:", error);
                        updateStatus("‚ùå Error al guardar la caja. Intenta de nuevo.", 'error');
                    });
            }).catch(error => {
                console.error("Error al verificar BX:", error);
                updateStatus("‚ùå Error al verificar el BX. Intente de nuevo.", 'error');
            });
            input.value = "";
        }

        function configurarEscaneo(idTarima) {
            const input = document.getElementById("codigoCaja");
            input.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    procesarEscaneo(input.value.trim(), idTarima);
                }
            });
        }

        function actualizarResumenTarima(idTarima) {
            db.ref(`tarimas/${idTarima}/cajas`).once("value").then(snapshot => {
                const cajas = snapshot.val();
                const totalCajas = cajas ? Object.keys(cajas).length : 0;
                let totalPiezas = 0;
                let lista = "";
                const cajasPorOrden = {};
                snapshot.forEach(cajaSnapshot => {
                    const caja = cajaSnapshot.val();
                    const cajaId = cajaSnapshot.key;
                    totalPiezas += caja.cantidadPiezas || 0;
                    const orden = caja.numeroOrden;
                    if (!cajasPorOrden[orden]) {
                        cajasPorOrden[orden] = {
                            totalPiezas: 0,
                            cajas: []
                        };
                    }
                    cajasPorOrden[orden].totalPiezas += caja.cantidadPiezas || 0;
                    cajasPorOrden[orden].cajas.push({ id: cajaId, codigo: caja.codigoCaja });
                });
                for (const orden in cajasPorOrden) {
                    const datos = cajasPorOrden[orden];
                    lista += `
                        <li>
                            Orden: ${orden} | Piezas: ${datos.totalPiezas}
                            <button onclick="toggleCajas('cajas-${orden}')" class="btn-secondary list-item-btn">Ver cajas</button>
                            <ul id="cajas-${orden}" style="display:none;">
                                ${datos.cajas.map(c => `<li>${c.codigo} <button onclick="eliminarCaja('${idTarima}', '${c.id}')" class="btn-danger list-item-btn">üóëÔ∏è</button></li>`).join("")}
                            </ul>
                        </li>
                    `;
                }
                const resumenTarimaElement = document.getElementById("resumenTarima");
                const listaCajasElement = document.getElementById("listaCajas");
                if (resumenTarimaElement && listaCajasElement) {
                    resumenTarimaElement.innerText = `Cajas: ${totalCajas} | Piezas: ${totalPiezas}`;
                    listaCajasElement.innerHTML = lista;
                }
                actualizarResumenTurno();
            });
        }

        function eliminarCaja(idTarima, idCaja) {
            if (confirm("¬øEst√°s seguro de que quieres eliminar esta caja?")) {
                db.ref(`tarimas/${idTarima}/cajas/${idCaja}`).remove()
                    .then(() => {
                        updateStatus("Caja eliminada correctamente.", 'success');
                        actualizarResumenTarima(idTarima);
                    })
                    .catch(error => {
                        console.error("Error al eliminar la caja:", error);
                        updateStatus("Hubo un error al eliminar la caja. Intenta de nuevo.", 'error');
                    });
            }
        }

        function terminarRegistroTarima(idTarima) {
            db.ref(`tarimas/${idTarima}/cajas`).once("value").then(snapshot => {
                const cajas = snapshot.val();
                const totalCajas = cajas ? Object.keys(cajas).length : 0;
                const cajasAInspeccionar = Math.ceil(totalCajas * 0.20);
                mostrarPopupInspeccion(idTarima, totalCajas, cajasAInspeccionar);
                mostrarPantallaOpcionesRecoleccion(administradores.includes(empleadoActual) ? 'administrador' : 'recolector');
                updateStatus("Listo para crear una nueva tarima.", 'info');
            });
        }

        function mostrarPopupInspeccion(idTarima, totalCajas, cajasAInspeccionar) {
            const popup = document.createElement('div');
            popup.id = 'inspeccionPopup';
            popup.innerHTML = `
                <div class="card popup-content">
                    <h3>‚úÖ Registro de Tarima Finalizado</h3>
                    <p>ID de Tarima: <b>${idTarima}</b></p>
                    <p>Total de cajas en la tarima: <b>${totalCajas}</b></p>
                    <p style="font-size: 1.2em; font-weight: bold; color: #ffeb3b;">Cajas a inspeccionar: <b>${cajasAInspeccionar}</b></p>
                    <button onclick="document.getElementById('inspeccionPopup').remove()" class="btn-primary">Aceptar</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function toggleCajas(id) {
            const lista = document.getElementById(id);
            if (lista) {
                lista.style.display = lista.style.display === "none" ? "block" : "none";
            }
        }

        function mostrarTarimasCreadas() {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card">
                    <h2>üìã Historial de Tarimas</h2>
                    <p>Aqu√≠ puedes ver todas las tarimas registradas.</p>
                    <button onclick="mostrarPantallaOpcionesRecoleccion('administrador')" class="btn-primary">‚¨ÖÔ∏è Regresar</button>
                    <div id="statusMessage"></div>
                    <ul id="listaTarimas"></ul>
                </div>
            `;

            updateStatus("Cargando historial de tarimas...", 'info');
            db.ref("tarimas").once("value").then(snapshot => {
                let lista = "";
                snapshot.forEach(tarimaSnapshot => {
                    const tarima = tarimaSnapshot.val();
                    const fecha = new Date(tarima.fechaCreacion).toLocaleString();
                    let totalCajas = tarima.cajas ? Object.keys(tarima.cajas).length : 0;
                    const estadoTarima = tarima.estado === 'confirmada' ? '‚úÖ Confirmada' : (tarima.estado === 'confirmadaConFaltantes' ? '‚ö†Ô∏è Confirmada con faltantes' : '‚ùå Pendiente');
                    lista += `
                        <li>
                            Tarima: ${tarima.id} | Empleado: ${tarima.empleadoId} | Cajas: ${totalCajas}
                            <br>Estado: ${estadoTarima}
                            <br><small>Creada el ${fecha}</small>
                            <button onclick="toggleCajas('cajas-historial-${tarima.id}')" class="btn-secondary list-item-btn">Ver cajas</button>
                            <ul id="cajas-historial-${tarima.id}" style="display:none;">
                                ${Object.values(tarima.cajas || {}).map(caja => `<li>${caja.codigoCaja} - ${caja.confirmado ? '‚úÖ Confirmado' : '‚ùå Pendiente'}</li>`).join("")}
                            </ul>
                        </li>
                    `;
                });
                document.getElementById("listaTarimas").innerHTML = lista;
                updateStatus("Historial cargado correctamente.", 'success');
            }).catch(error => {
                console.error("Error al cargar las tarimas:", error);
                updateStatus("‚ùå Error al cargar el historial. Intente de nuevo.", 'error');
            });
        }

        /**
         * @description NUEVO BLOQUE: Funcionalidad para Recolectores para ver y editar sus propias tarimas
         */
        function mostrarEdicionTarimasRecolector() {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card">
                    <h2>üìù Mis Tarimas</h2>
                    <p>Seleccione una de tus tarimas para editar o eliminar.</p>
                    <button onclick="mostrarPantallaOpcionesRecoleccion('recolector')" class="btn-primary">‚¨ÖÔ∏è Regresar</button>
                    <div id="statusMessage"></div>
                    <ul id="listaEdicionTarimas"></ul>
                </div>
            `;
            updateStatus("Cargando tus tarimas...", 'info');

            db.ref("tarimas").orderByChild("empleadoId").equalTo(empleadoActual).once("value").then(snapshot => {
                let lista = "";
                if (!snapshot.exists()) {
                    lista = `<li>A√∫n no has creado ninguna tarima.</li>`;
                } else {
                    snapshot.forEach(tarimaSnapshot => {
                        const tarima = tarimaSnapshot.val();
                        const fecha = new Date(tarima.fechaCreacion).toLocaleString();
                        const estadoTarima = tarima.estado === 'confirmada' ? '‚úÖ Confirmada' : (tarima.estado === 'confirmadaConFaltantes' ? '‚ö†Ô∏è Confirmada con faltantes' : '‚ùå Pendiente');
                        lista += `
                            <li>
                                Tarima: ${tarima.id} | Estado: ${estadoTarima}
                                <br><small>Creada el ${fecha}</small>
                                <div class="edit-delete-btns">
                                    <button onclick="editarTarima('${tarima.id}')" class="btn-primary">‚úèÔ∏è Editar</button>
                                    <button onclick="eliminarTarima('${tarima.id}')" class="btn-danger">üóëÔ∏è Eliminar</button>
                                </div>
                            </li>
                        `;
                    });
                }
                document.getElementById("listaEdicionTarimas").innerHTML = lista;
                updateStatus("Lista cargada correctamente.", 'success');
            }).catch(error => {
                console.error("Error al cargar las tarimas:", error);
                updateStatus("‚ùå Error al cargar la lista. Intente de nuevo.", 'error');
            });
        }


        function solicitarAccesoEdicion() {
            const password = prompt("Por favor, ingrese la contrase√±a para editar/eliminar tarimas:");
            if (password === "BORRAR25") {
                mostrarEdicionTarimas();
            } else {
                alert("Contrase√±a incorrecta. Acceso denegado.");
            }
        }

        function mostrarEdicionTarimas() {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card">
                    <h2>üìù Editar/Eliminar Tarimas</h2>
                    <p>Seleccione una tarima para editar o eliminar.</p>
                    <button onclick="mostrarPantallaOpcionesRecoleccion('administrador')" class="btn-primary">‚¨ÖÔ∏è Regresar</button>
                    <div id="statusMessage"></div>
                    <ul id="listaEdicionTarimas"></ul>
                </div>
            `;
            updateStatus("Cargando lista de tarimas...", 'info');

            db.ref("tarimas").once("value").then(snapshot => {
                let lista = "";
                snapshot.forEach(tarimaSnapshot => {
                    const tarima = tarimaSnapshot.val();
                    const fecha = new Date(tarima.fechaCreacion).toLocaleString();
                    const estadoTarima = tarima.estado === 'confirmada' ? '‚úÖ Confirmada' : (tarima.estado === 'confirmadaConFaltantes' ? '‚ö†Ô∏è Confirmada con faltantes' : '‚ùå Pendiente');
                    lista += `
                        <li>
                            Tarima: ${tarima.id} | Turno: ${tarima.turno}
                            <br>Estado: ${estadoTarima}
                            <br><small>Creada el ${fecha}</small>
                            <div class="edit-delete-btns">
                                <button onclick="editarTarima('${tarima.id}')" class="btn-primary">‚úèÔ∏è Editar</button>
                                <button onclick="eliminarTarima('${tarima.id}')" class="btn-danger">üóëÔ∏è Eliminar</button>
                            </div>
                        </li>
                    `;
                });
                document.getElementById("listaEdicionTarimas").innerHTML = lista;
                updateStatus("Lista cargada correctamente.", 'success');
            }).catch(error => {
                console.error("Error al cargar las tarimas:", error);
                updateStatus("‚ùå Error al cargar la lista. Intente de nuevo.", 'error');
            });
        }

        function editarTarima(idTarima) {
            currentTarima = idTarima;
            mostrarFormularioTarima(idTarima);
            updateStatus(`Editando tarima ${idTarima}`, 'info');
        }

        function eliminarTarima(idTarima) {
            if (confirm(`¬øEst√° seguro de que desea eliminar la tarima ${idTarima} y todas sus cajas?`)) {
                db.ref(`tarimas/${idTarima}`).remove()
                    .then(() => {
                        alert(`La tarima ${idTarima} ha sido eliminada.`)
                        const rol = administradores.includes(empleadoActual) ? 'administrador' : 'recolector';
                        if (rol === 'administrador') {
                            mostrarEdicionTarimas();
                        } else {
                            mostrarEdicionTarimasRecolector();
                        }
                    })
                    .catch(error => {
                        console.error("Error al eliminar la tarima:", error);
                        alert("Hubo un error al eliminar la tarima. Intente de nuevo.");
                    });
            }
        }

        // --- FUNCIONES DE CONFIRMACI√ìN ---

        function mostrarPantallaConfirmacionCaja() {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card">
                    <h2>‚úÖ Confirmaci√≥n de Tarima</h2>
                    <h3>Confirmador: <b>${confirmadorActual}</b></h3>
                    <p>Escanee el c√≥digo de una caja (BX) de la tarima a confirmar.</p>
                    <div id="statusMessage"></div>
                    <input type="text" id="cajaConfirmacionInput" placeholder="Escanear BX-XXX">
                    ${isMobile ? `<button id="btnEscCajaConf" class="btn-primary">üì∑ Iniciar escaneo</button>` : ""}
                    <button onclick="iniciarFlujoConfirmacion()" class="btn-secondary">‚¨ÖÔ∏è Regresar</button>
                </div>
            `;
            updateStatus("Esperando escaneo de caja...", 'info');
            const input = document.getElementById("cajaConfirmacionInput");
            input.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    buscarTarimaPorCaja(input.value.trim());
                }
            });

            if (isMobile) {
                document.getElementById("btnEscCajaConf").addEventListener("click", () => {
                    iniciarEscaneo("cajaConfirmacion");
                });
            }
        }

        function buscarTarimaPorCaja(codigoCaja) {
            if (!codigoCaja.startsWith('BX')) {
                updateStatus("‚ùå Error: El c√≥digo de caja debe empezar con 'BX'.", 'error');
                setTimeout(() => mostrarPantallaConfirmacionCaja(), 1500);
                return;
            }

            db.ref("tarimas").once("value").then(snapshot => {
                let tarimaEncontrada = null;
                let cajaEncontrada = null;
                snapshot.forEach(tarimaSnapshot => {
                    const tarima = tarimaSnapshot.val();
                    if (tarima.cajas) {
                        for (let key in tarima.cajas) {
                            if (tarima.cajas[key].codigoCaja === codigoCaja) {
                                tarimaEncontrada = tarima;
                                cajaEncontrada = tarima.cajas[key];
                                tarimaAConfirmar = tarima.id;
                                break;
                            }
                        }
                    }
                    if (tarimaEncontrada) {
                        return true;
                    }
                });

                if (!tarimaEncontrada) {
                    updateStatus("‚ùå Error: Caja no encontrada en ninguna tarima.", 'error');
                    setTimeout(() => mostrarPantallaConfirmacionCaja(), 1500);
                    return;
                }

                if (cajaEncontrada.confirmado) {
                    const fecha = new Date(cajaEncontrada.fechaConfirmacion).toLocaleString();
                    const confirmador = cajaEncontrada.confirmadorId || 'No disponible';
                    updateStatus(`‚ùå Error: El BX ${codigoCaja} ya fue confirmado por ${confirmador} el ${fecha}.`, 'error');
                    setTimeout(() => mostrarPantallaConfirmacionCaja(), 4000);
                    return;
                }
                
                mostrarFormularioConfirmacionCajas(tarimaEncontrada);
                procesarConfirmacionCaja(codigoCaja);

            }).catch(error => {
                console.error("Error al buscar la tarima por caja:", error);
                updateStatus("‚ùå Error al buscar la tarima. Intente de nuevo.", 'error');
                setTimeout(() => mostrarPantallaConfirmacionCaja(), 1500);
            });
        }

        function mostrarFormularioConfirmacionCajas(tarimaData) {
            const contenedor = document.getElementById("pantalla5");
            const cajasPendientes = Object.values(tarimaData.cajas || {}).filter(caja => !caja.confirmado).length;
            const cajasConfirmadas = Object.values(tarimaData.cajas || {}).filter(caja => caja.confirmado).length;
            const totalCajas = Object.values(tarimaData.cajas || {}).length;

            contenedor.innerHTML = `
                <div class="card">
                    <h2>‚úÖ Confirmando Tarima: ${tarimaData.id}</h2>
                    <h3>Recolector: <b>${tarimaData.empleadoId}</b></h3>
                    <h4>Cajas: <span id="cajasConfirmadas">${cajasConfirmadas}</span> / <span id="totalCajas">${totalCajas}</span> confirmadas</h4>
                    <div id="statusMessage"></div>
                    <input type="text" id="cajaConfirmacionInput" placeholder="Escanear BX-XXX">
                    ${isMobile ? `<button id="btnEscCajaConf" class="btn-primary">üì∑ Iniciar escaneo</button>` : ""}
                    <h4>Cajas pendientes</h4>
                    <ul id="listaCajasConfirmacion"></ul>
                    <button onclick="terminarConfirmacion()" class="btn-green">‚úÖ Finalizar Confirmaci√≥n</button>
                    <button onclick="iniciarFlujoConfirmacion()" class="btn-danger">‚ùå Cancelar</button>
                </div>
            `;
            updateStatus("Escanear el c√≥digo de cada caja para confirmar.", 'info');

            if (isMobile) {
                document.getElementById("btnEscCajaConf").addEventListener("click", () => {
                    iniciarEscaneo("cajaConfirmacion");
                });
            }

            const input = document.getElementById("cajaConfirmacionInput");
            input.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    procesarConfirmacionCaja(input.value.trim());
                }
            });

            actualizarListaConfirmacion(tarimaData.id);
        }

        function procesarConfirmacionCaja(codigoCaja) {
            if (!codigoCaja.startsWith('BX')) {
                updateStatus("‚ùå Error: El c√≥digo de caja debe empezar con 'BX'.", 'error');
                return;
            }
            db.ref("tarimas").once("value").then(globalSnapshot => {
                let tarimaCorrectaId = null;
                let cajaData = null;
                let cajaKey = null;

                globalSnapshot.forEach(tarimaSnapshot => {
                    const tarima = tarimaSnapshot.val();
                    if (tarima.cajas) {
                        const foundCajaKey = Object.keys(tarima.cajas).find(key => tarima.cajas[key].codigoCaja === codigoCaja);
                        if (foundCajaKey) {
                            tarimaCorrectaId = tarima.id;
                            cajaData = tarima.cajas[foundCajaKey];
                            cajaKey = foundCajaKey;
                            return true; // Salir del bucle
                        }
                    }
                });

                if (!tarimaCorrectaId) {
                    updateStatus("‚ùå Error: Caja no encontrada en ninguna tarima.", 'error');
                    return;
                }

                if (tarimaCorrectaId !== tarimaAConfirmar) {
                    updateStatus(`‚ùå Error: Esta caja pertenece a la tarima: ${tarimaCorrectaId}. Separe el material y contin√∫e.`, 'error');
                    return;
                }
                
                if (cajaData.confirmado) {
                    const fecha = new Date(cajaData.fechaConfirmacion).toLocaleString();
                    const confirmador = cajaData.confirmadorId || 'No disponible';
                    updateStatus(`‚ùå Error: El BX ${codigoCaja} ya fue confirmado por ${confirmador} el ${fecha}.`, 'error');
                } else {
                    db.ref(`tarimas/${tarimaAConfirmar}/cajas/${cajaKey}`).update({
                        confirmado: true,
                        confirmadorId: confirmadorActual,
                        fechaConfirmacion: new Date().toISOString(),
                        estadoFinal: 'confirmado'
                    }).then(() => {
                        updateStatus(`‚úÖ Caja ${codigoCaja} confirmada.`, 'success');
                        actualizarListaConfirmacion(tarimaAConfirmar);
                    }).catch(error => {
                        console.error("Error al confirmar la caja:", error);
                        updateStatus("‚ùå Error al confirmar la caja. Intente de nuevo.", 'error');
                    });
                }
            });
        }

        function actualizarListaConfirmacion(idTarima) {
            db.ref(`tarimas/${idTarima}`).once("value").then(snapshot => {
                const tarimaData = snapshot.val();
                const cajas = tarimaData.cajas || {};
                const listaUl = document.getElementById("listaCajasConfirmacion");
                const cajasConfirmadasCount = Object.values(cajas).filter(caja => caja.confirmado).length;
                const totalCajas = Object.keys(cajas).length;
                
                document.getElementById("cajasConfirmadas").textContent = cajasConfirmadasCount;
                document.getElementById("totalCajas").textContent = totalCajas;

                let listaHTML = "";
                for (const key in cajas) {
                    const caja = cajas[key];
                    if (!caja.confirmado) {
                        listaHTML += `<li>‚ùå ${caja.codigoCaja}</li>`;
                    }
                }
                listaUl.innerHTML = listaHTML;
            });
        }
        
        function terminarConfirmacion() {
            db.ref(`tarimas/${tarimaAConfirmar}`).once("value").then(snapshot => {
                const tarimaData = snapshot.val();
                const cajas = tarimaData.cajas || {};
                
                const cajasPendientes = Object.entries(cajas).filter(([key, caja]) => !caja.confirmado);
                const updates = {};
                
                updates[`tarimas/${tarimaAConfirmar}/fechaConfirmacion`] = new Date().toISOString();
                updates[`tarimas/${tarimaAConfirmar}/confirmadorId`] = confirmadorActual;

                if (cajasPendientes.length > 0) {
                    if (confirm(`A√∫n hay ${cajasPendientes.length} cajas pendientes. ¬øDesea finalizar la confirmaci√≥n y marcarlas como faltantes?`)) {
                        updates[`tarimas/${tarimaAConfirmar}/estado`] = 'confirmadaConFaltantes';
                        
                        cajasPendientes.forEach(([key, caja]) => {
                            updates[`tarimas/${tarimaAConfirmar}/cajas/${key}/estadoFinal`] = 'faltante';
                        });
                        
                        db.ref().update(updates).then(() => {
                            updateStatus(`‚ö†Ô∏è Tarima confirmada con faltantes.`, 'info');
                            setTimeout(() => {
                                tarimaAConfirmar = null;
                                confirmadorActual = null;
                                mostrarPantallaInicio();
                            }, 2000);
                        }).catch(error => {
                            console.error("Error al finalizar con faltantes:", error);
                            updateStatus("‚ùå Error al finalizar. Intente de nuevo.", 'error');
                        });
                    }
                } else {
                    updates[`tarimas/${tarimaAConfirmar}/estado`] = 'confirmada';

                    db.ref().update(updates).then(() => {
                        updateStatus("‚úÖ Tarima confirmada con √©xito. Proceso finalizado.", 'success');
                        tarimaAConfirmar = null;
                        confirmadorActual = null;
                        setTimeout(() => mostrarPantallaInicio(), 2000);
                    }).catch(error => {
                        console.error("Error al finalizar la tarima:", error);
                        updateStatus("‚ùå Error al finalizar. Intente de nuevo.", 'error');
                    });
                }
            });
        }

        // --- FUNCIONES DE VERIFICACI√ìN ---

        function iniciarFlujoVerificacion() {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card">
                    <h2>üîé Verificaci√≥n de BX</h2>
                    <p>Escanee el c√≥digo del BX para verificar su estado y tarima.</p>
                    <div id="statusMessage"></div>
                    <input type="text" id="verificacionInput" placeholder="Escanear BX-XXX">
                    ${isMobile ? `<button id="btnEscVerificacion" class="btn-secondary">üì∑ Iniciar escaneo</button>` : ""}
                    <button onclick="mostrarPantallaInicio()" class="btn-primary">‚¨ÖÔ∏è Regresar</button>
                </div>
            `;
            updateStatus("Esperando escaneo de BX...", 'info');
            const input = document.getElementById("verificacionInput");
            input.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    buscarYMostrarInfoBX(input.value.trim());
                }
            });

            if (isMobile) {
                document.getElementById("btnEscVerificacion").addEventListener("click", () => {
                    iniciarEscaneo("verificacion");
                });
            }
        }

        function buscarYMostrarInfoBX(codigoCaja) {
            if (!codigoCaja.startsWith('BX')) {
                updateStatus("‚ùå Error: El c√≥digo de caja debe empezar con 'BX'.", 'error');
                return;
            }

            db.ref("tarimas").once("value").then(snapshot => {
                let tarimaEncontrada = null;
                let cajaEncontrada = null;
                snapshot.forEach(tarimaSnapshot => {
                    const tarima = tarimaSnapshot.val();
                    if (tarima.cajas) {
                        for (let key in tarima.cajas) {
                            if (tarima.cajas[key].codigoCaja === codigoCaja) {
                                tarimaEncontrada = tarima;
                                cajaEncontrada = tarima.cajas[key];
                                break;
                            }
                        }
                    }
                    if (tarimaEncontrada) {
                        return true;
                    }
                });

                if (!tarimaEncontrada) {
                    updateStatus("‚ùå Error: Caja no encontrada en ninguna tarima.", 'error');
                    return;
                }
                
                mostrarInfoTarima(tarimaEncontrada, codigoCaja);

            }).catch(error => {
                console.error("Error al buscar la tarima por caja:", error);
                updateStatus("‚ùå Error al buscar la tarima. Intente de nuevo.", 'error');
            });
        }
        
        function mostrarInfoTarima(tarimaData, codigoCajaEscaneado) {
            const contenedor = document.getElementById("pantalla5");
            const totalCajas = Object.keys(tarimaData.cajas || {}).length;
            const cajasHtml = Object.values(tarimaData.cajas || {}).map(caja => {
                const estado = caja.confirmado ? '‚úÖ Confirmado' : '‚ùå Pendiente';
                const isScanned = caja.codigoCaja === codigoCajaEscaneado;
                const highlight = isScanned ? 'background-color: #34c759; color: #FFFFFF;' : '';
                return `<li style="${highlight}">${caja.codigoCaja} - ${estado}</li>`;
            }).join('');
            
            contenedor.innerHTML = `
                <div class="card">
                    <h2>üîé Informaci√≥n de Tarima</h2>
                    <h3>Tarima: <b>${tarimaData.id}</b></h3>
                    <p><b>Recolector:</b> ${tarimaData.empleadoId}</p>
                    <p><b>Estado de Tarima:</b> ${tarimaData.estado === 'confirmada' ? '‚úÖ Confirmada' : (tarimaData.estado === 'confirmadaConFaltantes' ? '‚ö†Ô∏è Confirmada con Faltantes' : '‚ùå Pendiente')}</p>
                    <p><b>Total de cajas:</b> ${totalCajas}</p>
                    <hr>
                    <h4>Cajas en la Tarima:</h4>
                    <ul id="listaInfoCajas">${cajasHtml}</ul>
                    <div id="statusMessage"></div>
                    <button onclick="iniciarFlujoVerificacion()" class="btn-secondary">üîé Verificar otro BX</button>
                    <button onclick="mostrarPantallaInicio()" class="btn-primary">‚¨ÖÔ∏è Regresar a Inicio</button>
                </div>
            `;
            updateStatus(`Informaci√≥n para el BX: ${codigoCajaEscaneado}`, 'info');
        }


        // --- FUNCIONES DE AN√ÅLISIS ---

        function mostrarAnalisisDiscrepancias() {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card">
                    <h2>üîé An√°lisis de Discrepancias</h2>
                    <p>Tarimas confirmadas con cajas faltantes.</p>
                    <button onclick="mostrarPantallaOpcionesRecoleccion('administrador')" class="btn-primary">‚¨ÖÔ∏è Regresar</button>
                    <div id="statusMessage"></div>
                    <ul id="listaDiscrepancias"></ul>
                </div>
            `;
            updateStatus("Cargando tarimas con faltantes...", 'info');

            db.ref("tarimas").orderByChild("estado").equalTo("confirmadaConFaltantes").once("value").then(snapshot => {
                let lista = "";
                if (!snapshot.exists()) {
                    lista = `<li>‚úÖ No se encontraron tarimas con discrepancias.</li>`;
                } else {
                    snapshot.forEach(tarimaSnapshot => {
                        const tarima = tarimaSnapshot.val();
                        const cajas = tarima.cajas || {};
                        const cajasFaltantes = Object.values(cajas).filter(caja => caja.estadoFinal === 'faltante');
                        
                        if (cajasFaltantes.length > 0) {
                            const fechaConfirmacionStr = tarima.fechaConfirmacion ? new Date(tarima.fechaConfirmacion).toLocaleString() : 'Fecha no disponible';
                            lista += `
                                <li onclick="toggleDiscrepancyDetails('details-${tarima.id}')" style="cursor: pointer;">
                                    <h4>‚ö†Ô∏è Tarima: ${tarima.id}</h4>
                                    <div id="details-${tarima.id}" style="display:none; margin-top: 10px; border-top: 1px solid #3a3a3c; padding-top: 10px;">
                                        <p><b>Recolector:</b> ${tarima.empleadoId}</p>
                                        <p><b>Confirmador:</b> ${tarima.confirmadorId || 'No disponible'}</p>
                                        <p><b>Fecha de √∫ltima confirmaci√≥n:</b> ${fechaConfirmacionStr}</p>
                                        <p><b>Cajas faltantes:</b> ${cajasFaltantes.length}</p>
                                        <ul>
                                            ${cajasFaltantes.map(caja => `<li>‚ùå ${caja.codigoCaja}</li>`).join('')}
                                        </ul>
                                    </div>
                                </li>
                            `;
                        }
                    });
                }
                document.getElementById("listaDiscrepancias").innerHTML = lista;
                updateStatus("An√°lisis de discrepancias cargado.", 'success');
            }).catch(error => {
                console.error("Error al cargar las discrepancias:", error);
                updateStatus("‚ùå Error al cargar las discrepancias. Intente de nuevo.", 'error');
            });
        }
        
        function toggleDiscrepancyDetails(id) {
            const detailsDiv = document.getElementById(id);
            if (detailsDiv) {
                detailsDiv.style.display = detailsDiv.style.display === "none" ? "block" : "none";
            }
        }

        /**
         * @description NUEVO BLOQUE: Reportes y An√°lisis para Administradores
         * Se agreg√≥ la UI de filtros y la l√≥gica para generar reportes detallados.
         */
        function mostrarReportesYAnalisis() {
            const contenedor = document.getElementById("pantalla5");
            const fechaHoy = new Date().toISOString().slice(0, 10);
            contenedor.innerHTML = `
                <div class="card">
                    <h2>üìä Reportes y An√°lisis</h2>
                    <p>Filtra y analiza los datos de recolecci√≥n.</p>
                    <div class="report-filters">
                        <input type="date" id="filtroFechaInicio" value="${fechaHoy}">
                        <input type="date" id="filtroFechaFin" value="${fechaHoy}">
                        <select id="filtroTurno">
                            <option value="todos">Todos los turnos</option>
                            <option value="Turno 1">Turno 1</option>
                            <option value="Turno 2">Turno 2</option>
                        </select>
                        <input type="text" id="filtroEmpleado" placeholder="ID de Empleado">
                        <select id="filtroEstado">
                            <option value="todos">Todos los estados</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="confirmada">Confirmada</option>
                            <option value="confirmadaConFaltantes">Con Faltantes</option>
                        </select>
                    </div>
                    <button onclick="generarReporte()" class="btn-primary">üîç Generar Reporte</button>
                    <button onclick="mostrarPantallaOpcionesRecoleccion('administrador')" class="btn-secondary">‚¨ÖÔ∏è Regresar</button>
                    <div id="statusMessage"></div>
                    <div id="reporteResultados" class="report-section">
                        <h4>Resultados</h4>
                        <ul id="listaResultadosReporte" class="report-results-list">
                            <li>Usa los filtros y haz clic en "Generar Reporte" para ver los resultados.</li>
                        </ul>
                    </div>
                </div>
            `;
            updateStatus("Listo para generar un reporte.", 'info');
        }

        function generarReporte() {
            updateStatus("Generando reporte...", 'info');
            const fechaInicio = document.getElementById("filtroFechaInicio").value;
            const fechaFin = document.getElementById("filtroFechaFin").value;
            const turno = document.getElementById("filtroTurno").value;
            const empleadoId = document.getElementById("filtroEmpleado").value.trim();
            const estado = document.getElementById("filtroEstado").value;
            
            db.ref("tarimas").once("value").then(snapshot => {
                let resultados = [];
                snapshot.forEach(tarimaSnapshot => {
                    const tarima = tarimaSnapshot.val();
                    const fechaCreacion = tarima.fechaCreacion.slice(0, 10);

                    const cumpleFiltros = 
                        (fechaCreacion >= fechaInicio && fechaCreacion <= fechaFin) &&
                        (turno === 'todos' || tarima.turno === turno) &&
                        (empleadoId === '' || tarima.empleadoId === empleadoId) &&
                        (estado === 'todos' || tarima.estado === estado);

                    if (cumpleFiltros) {
                        resultados.push(tarima);
                    }
                });

                mostrarResultadosReporte(resultados);
            }).catch(error => {
                console.error("Error al generar el reporte:", error);
                updateStatus("‚ùå Error al generar el reporte. Intente de nuevo.", 'error');
            });
        }

        function mostrarResultadosReporte(resultados) {
            const listaResultados = document.getElementById("listaResultadosReporte");
            if (resultados.length === 0) {
                listaResultados.innerHTML = `<li>No se encontraron resultados con los filtros seleccionados.</li>`;
                updateStatus("Reporte generado. 0 resultados encontrados.", 'info');
                return;
            }

            let html = "";
            let totalCajas = 0;
            let totalPiezas = 0;

            resultados.forEach(tarima => {
                const numCajas = tarima.cajas ? Object.keys(tarima.cajas).length : 0;
                totalCajas += numCajas;
                let piezasTarima = 0;
                let cajasHtml = "";
                const cajasPorOrden = {};
                if (tarima.cajas) {
                    Object.values(tarima.cajas).forEach(caja => {
                        piezasTarima += caja.cantidadPiezas || 0;
                        const orden = caja.numeroOrden;
                        if (!cajasPorOrden[orden]) {
                            cajasPorOrden[orden] = [];
                        }
                        cajasPorOrden[orden].push(caja);
                    });
                }
                totalPiezas += piezasTarima;

                let ordenesHtml = "";
                for (const orden in cajasPorOrden) {
                    const cajasDeOrden = cajasPorOrden[orden];
                    const totalPiezasOrden = cajasDeOrden.reduce((sum, caja) => sum + (caja.cantidadPiezas || 0), 0);
                    const cajasListHtml = cajasDeOrden.map(c => `<li>${c.codigoCaja} (${c.cantidadPiezas} pz) - Estado: ${c.estadoFinal || 'N/A'}</li>`).join('');
                    ordenesHtml += `
                        <li style="margin-top: 10px;">
                            Orden: ${orden} | Total Piezas: ${totalPiezasOrden}
                            <button onclick="toggleCajas('orden-${tarima.id}-${orden}')" class="btn-secondary list-item-btn">Ver cajas</button>
                            <ul id="orden-${tarima.id}-${orden}" style="display:none;">
                                ${cajasListHtml}
                            </ul>
                        </li>
                    `;
                }

                html += `
                    <li>
                        <h4>Tarima: ${tarima.id}</h4>
                        <p><b>Recolector:</b> ${tarima.empleadoId}</p>
                        <p><b>Turno:</b> ${tarima.turno}</p>
                        <p><b>Fecha:</b> ${new Date(tarima.fechaCreacion).toLocaleDateString()}</p>
                        <p><b>Estado:</b> ${tarima.estado}</p>
                        <p><b>Cajas:</b> ${numCajas} | <b>Piezas:</b> ${piezasTarima}</p>
                        <button onclick="toggleDiscrepancyDetails('tarima-${tarima.id}')" class="btn-secondary">Detalles de √ìrdenes</button>
                        <div id="tarima-${tarima.id}" style="display: none; margin-top: 10px;">
                            <ul style="padding-left: 20px;">
                                ${ordenesHtml}
                            </ul>
                        </div>
                    </li>
                `;
            });

            listaResultados.innerHTML = `
                <p style="font-weight: bold;">Resultados totales: ${resultados.length} tarimas | ${totalCajas} cajas | ${totalPiezas} piezas</p>
                <hr>
                ${html}
            `;
            updateStatus("Reporte generado correctamente.", 'success');
        }

        /**
         * @description NUEVO BLOQUE: Dashboard de Monitoreo para Administradores
         * Se agreg√≥ la UI para una vista general del estado de las tarimas.
         */
        function mostrarDashboardAdmin() {
            const contenedor = document.getElementById("pantalla5");
            contenedor.innerHTML = `
                <div class="card dashboard-container">
                    <h2>üìà Dashboard de Monitoreo</h2>
                    <p>Vista general del estado de las tarimas.</p>
                    <div id="dashboardResumen" style="display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 20px;">
                        <div style="background-color: #ffc107; color: black; padding: 15px; border-radius: 10px; margin: 5px; min-width: 120px;">
                            <h4>Pendientes</h4>
                            <h2 id="pendingCount">0</h2>
                        </div>
                        <div style="background-color: #4CAF50; color: white; padding: 15px; border-radius: 10px; margin: 5px; min-width: 120px;">
                            <h4>Confirmadas</h4>
                            <h2 id="confirmedCount">0</h2>
                        </div>
                        <div style="background-color: #ff3b30; color: white; padding: 15px; border-radius: 10px; margin: 5px; min-width: 120px;">
                            <h4>Faltantes</h4>
                            <h2 id="missingCount">0</h2>
                        </div>
                    </div>
                    <button onclick="actualizarDashboard()" class="btn-primary">üîÑ Actualizar datos</button>
                    <button onclick="mostrarPantallaOpcionesRecoleccion('administrador')" class="btn-secondary">‚¨ÖÔ∏è Regresar</button>
                    <div id="statusMessage"></div>
                    <ul id="listaDashboardTarimas"></ul>
                </div>
            `;
            actualizarDashboard();
        }

        function actualizarDashboard() {
            updateStatus("Actualizando Dashboard...", 'info');
            db.ref("tarimas").once("value").then(snapshot => {
                let pending = 0;
                let confirmed = 0;
                let missing = 0;
                let listaHtml = "";

                snapshot.forEach(tarimaSnapshot => {
                    const tarima = tarimaSnapshot.val();
                    const estado = tarima.estado;
                    let cajasConFaltantes = 0;
                    if (tarima.cajas) {
                        cajasConFaltantes = Object.values(tarima.cajas).filter(caja => caja.estadoFinal === 'faltante').length;
                    }

                    if (estado === 'pendiente') {
                        pending++;
                        listaHtml += `<li>‚ùå **Tarima Pendiente:** ${tarima.id}</li>`;
                    } else if (estado === 'confirmada') {
                        confirmed++;
                        listaHtml += `<li>‚úÖ **Tarima Confirmada:** ${tarima.id}</li>`;
                    } else if (estado === 'confirmadaConFaltantes') {
                        missing++;
                        listaHtml += `<li>‚ö†Ô∏è **Tarima con Faltantes:** ${tarima.id} (Faltantes: ${cajasConFaltantes})</li>`;
                    }
                });
                
                document.getElementById("pendingCount").textContent = pending;
                document.getElementById("confirmedCount").textContent = confirmed;
                document.getElementById("missingCount").textContent = missing;
                document.getElementById("listaDashboardTarimas").innerHTML = listaHtml || '<li>No hay tarimas registradas.</li>';
                updateStatus("Dashboard actualizado.", 'success');
            }).catch(error => {
                console.error("Error al actualizar el dashboard:", error);
                updateStatus("‚ùå Error al cargar los datos del Dashboard.", 'error');
            });
        }


        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const path = window.location.pathname.split('/').slice(0, -1).join('/');
                navigator.serviceWorker.register(`${path}/sw.js`, { scope: `${path}/` })
                    .then(reg => {
                        console.log("‚úÖ Service Worker registrado con √©xito:", reg);
                    })
                    .catch(err => {
                        console.error("‚ùå Error al registrar Service Worker:", err);
                    });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            mostrarPantallaInicio();
            document.getElementById('closeScannerBtn').addEventListener('click', detenerCamara);
        });

    </script>
</body>
</html>
